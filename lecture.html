<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AX2 실시간 강의 번역</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333333;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* 상단 헤더 */
        .header {
            background: #ffffff;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #4a9eff;
            cursor: pointer;
        }

        .nav-link {
            color: #666666;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .nav-link:hover {
            background: #f0f0f0;
        }

        .nav-link.active {
            color: #4a9eff;
            background: #f0f7ff;
        }

        .language-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .language-selector label {
            font-size: 14px;
            color: #666666;
        }

        .language-selector select {
            background: #ffffff;
            color: #333333;
            border: 1px solid #d0d0d0;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .login-btn {
            padding: 8px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .subtitle-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #d0d0d0;
            transition: 0.3s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: #ffffff;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked + .slider {
            background-color: #4a9eff;
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .subtitle-settings-btn {
            background: #ffffff;
            border: 1px solid #d0d0d0;
            color: #333333;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .subtitle-settings-btn:hover {
            background: #f0f0f0;
        }

        .ax2-translate-btn {
            background: linear-gradient(135deg, #4a9eff 0%, #357abd 100%);
            border: none;
            color: #ffffff;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(74, 158, 255, 0.3);
        }

        .ax2-translate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(74, 158, 255, 0.4);
        }

        .ax2-translate-btn.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .mic-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #666666;
            padding: 6px 12px;
            background: #f0f0f0;
            border-radius: 6px;
        }

        .mic-status.active {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .mic-status.active::before {
            content: '●';
            color: #4caf50;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* 알림 애니메이션 */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* 메인 콘텐츠 영역 */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* 좌측 영상 영역 */
        .video-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            background: #000000;
            position: relative;
        }

        .video-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000000;
        }

        .video-player {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .video-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #e0e0e0 0%, #f0f0f0 100%);
            color: #999999;
            font-size: 18px;
        }

        /* 자막 영역 */
        .subtitle-area {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 1200px;
            z-index: 10;
            transition: opacity 0.3s;
        }

        .subtitle-text {
            background: rgba(0, 0, 0, 0.8);
            color: #ffffff;
            padding: 15px 25px;
            border-radius: 8px;
            text-align: center;
            font-size: 24px;
            line-height: 1.6;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease, transform 0.3s ease;
            word-wrap: break-word;
            max-width: 100%;
        }

        .subtitle-text.updating {
            animation: subtitleUpdate 0.3s ease;
        }

        @keyframes subtitleUpdate {
            0% {
                transform: translateY(10px);
                opacity: 0.7;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .subtitle-area.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* 자막 설정 패널 */
        .subtitle-settings-panel {
            position: absolute;
            top: 60px;
            right: 20px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            width: 300px;
            z-index: 100;
            display: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .subtitle-settings-panel.show {
            display: block;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #4a9eff;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-label {
            display: block;
            font-size: 14px;
            color: #666666;
            margin-bottom: 8px;
        }

        .slider-control {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider-control::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4a9eff;
            cursor: pointer;
        }

        .slider-control::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4a9eff;
            cursor: pointer;
            border: none;
        }

        .color-picker-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-picker {
            width: 50px;
            height: 40px;
            border: 2px solid #d0d0d0;
            border-radius: 6px;
            cursor: pointer;
            background: #ffffff;
        }

        .color-preview {
            flex: 1;
            height: 40px;
            border-radius: 6px;
            border: 2px solid #d0d0d0;
            background: #ffffff;
        }

        /* 우측 번역 설정 영역 */
        .translation-settings-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            border-left: 1px solid #e0e0e0;
            min-width: 350px;
            max-width: 450px;
            overflow-y: auto;
        }

        .settings-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #fafafa;
        }

        .settings-title-main {
            font-size: 18px;
            font-weight: 600;
            color: #333333;
            margin-bottom: 5px;
        }

        .settings-subtitle {
            font-size: 12px;
            color: #999999;
        }

        .settings-content {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .setting-card {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
        }

        .setting-card-title {
            font-size: 14px;
            font-weight: 600;
            color: #333333;
            margin-bottom: 12px;
        }

        .setting-item {
            margin-bottom: 16px;
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        .setting-item-label {
            display: block;
            font-size: 13px;
            color: #666666;
            margin-bottom: 8px;
        }

        .setting-item select,
        .setting-item input[type="text"] {
            width: 100%;
            background: #ffffff;
            border: 1px solid #d0d0d0;
            color: #333333;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }

        .setting-item select:focus,
        .setting-item input[type="text"]:focus {
            border-color: #4a9eff;
        }

        .setting-item input[type="range"] {
            width: 100%;
        }

        .setting-value {
            text-align: right;
            font-size: 12px;
            color: #999999;
            margin-top: 5px;
        }

        /* 스크롤바 스타일 */
        .translation-settings-section::-webkit-scrollbar {
            width: 8px;
        }

        .translation-settings-section::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        .translation-settings-section::-webkit-scrollbar-thumb {
            background: #d0d0d0;
            border-radius: 4px;
        }

        .translation-settings-section::-webkit-scrollbar-thumb:hover {
            background: #b0b0b0;
        }

        /* 반응형 디자인 */
        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }

            .translation-settings-section {
                max-width: 100%;
                min-width: 100%;
                height: 400px;
            }

            .subtitle-settings-panel {
                right: 10px;
                width: 280px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 상단 헤더 -->
        <div class="header">
            <div class="header-left">
                <div class="logo" onclick="location.href='lecture.html'">AX2</div>
                <a href="lecture.html" class="nav-link active">강의</a>
                <a href="mypage.html" class="nav-link">마이페이지</a>
            </div>
            <div class="header-right">
                <div class="subtitle-controls">
                    <label style="font-size: 14px; color: #666666;">자막:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="subtitle-toggle" checked>
                        <span class="slider"></span>
                    </label>
                    <button class="subtitle-settings-btn" id="subtitle-settings-btn">자막 설정</button>
                </div>
                <div class="mic-status" id="mic-status" style="display: none;">
                    <span>마이크</span>
                </div>
                <button class="ax2-translate-btn" id="ax2-translate-btn">AX2 번역 시작</button>
                <button class="ax2-translate-btn" id="end-lecture-btn" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); margin-left: 10px;">강의 종료</button>
                <a href="login.html" class="login-btn">로그인</a>
            </div>
        </div>

        <!-- 메인 콘텐츠 -->
        <div class="main-content">
            <!-- 좌측 영상 영역 -->
            <div class="video-section">
                <div class="video-container">
                    <div class="video-placeholder">
                        <div>강의 영상이 여기에 표시됩니다</div>
                    </div>
                    <!-- 실제 사용 시 video 태그로 교체
                    <video class="video-player" controls>
                        <source src="lecture.mp4" type="video/mp4">
                    </video>
                    -->
                    
                    <!-- 자막 영역 -->
                    <div class="subtitle-area" id="subtitle-area">
                        <div class="subtitle-text" id="subtitle-text">
                            실시간 번역 자막이 여기에 표시됩니다
                        </div>
                    </div>

                    <!-- 자막 설정 패널 -->
                    <div class="subtitle-settings-panel" id="subtitle-settings-panel">
                        <div class="settings-title">자막 설정</div>
                        
                        <div class="setting-group">
                            <label class="setting-label">자막 크기</label>
                            <input type="range" class="slider-control" id="subtitle-size" min="16" max="48" value="24">
                            <div style="text-align: right; font-size: 12px; color: #999999; margin-top: 5px;">
                                <span id="size-value">24px</span>
                            </div>
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">배경 투명도</label>
                            <input type="range" class="slider-control" id="subtitle-opacity" min="0" max="100" value="80">
                            <div style="text-align: right; font-size: 12px; color: #999999; margin-top: 5px;">
                                <span id="opacity-value">80%</span>
                            </div>
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">배경 색상</label>
                            <div class="color-picker-group">
                                <input type="color" class="color-picker" id="subtitle-bg-color" value="#000000">
                                <div class="color-preview" id="color-preview"></div>
                            </div>
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">텍스트 색상</label>
                            <div class="color-picker-group">
                                <input type="color" class="color-picker" id="subtitle-text-color" value="#ffffff">
                                <div class="color-preview" id="text-color-preview"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 우측 번역 설정 영역 -->
            <div class="translation-settings-section">
                <div class="settings-header">
                    <div class="settings-title-main">번역 설정</div>
                    <div class="settings-subtitle">실시간 번역 옵션을 조정하세요</div>
                </div>
                <div class="settings-content">
                    <div class="setting-card">
                        <div class="setting-card-title">언어 설정</div>
                        <div class="setting-item">
                            <label class="setting-item-label">원본 언어</label>
                            <select id="source-language">
                                <option value="auto">자동 감지</option>
                                <option value="en">English</option>
                                <option value="ko">한국어</option>
                                <option value="ja">日本語</option>
                                <option value="zh">中文</option>
                                <option value="es">Español</option>
                                <option value="fr">Français</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label class="setting-item-label">번역 언어</label>
                            <select id="target-language-settings">
                                <option value="ko">한국어</option>
                                <option value="en">English</option>
                                <option value="ja">日本語</option>
                                <option value="zh">中文</option>
                                <option value="es">Español</option>
                                <option value="fr">Français</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-card">
                        <div class="setting-card-title">고급 설정</div>
                        <div class="setting-item">
                            <label class="setting-item-label">문맥 유지</label>
                            <select id="context-mode">
                                <option value="on" selected>켜기</option>
                                <option value="off">끄기</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label class="setting-item-label">전문 용어 사전</label>
                            <select id="glossary-mode">
                                <option value="off">사용 안 함</option>
                                <option value="on">사용</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 자막 ON/OFF 토글
        const subtitleToggle = document.getElementById('subtitle-toggle');
        const subtitleArea = document.getElementById('subtitle-area');

        subtitleToggle.addEventListener('change', function() {
            if (this.checked) {
                subtitleArea.classList.remove('hidden');
            } else {
                subtitleArea.classList.add('hidden');
            }
        });

        // 자막 설정 패널 토글
        const settingsBtn = document.getElementById('subtitle-settings-btn');
        const settingsPanel = document.getElementById('subtitle-settings-panel');

        settingsBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            settingsPanel.classList.toggle('show');
        });

        // 패널 외부 클릭 시 닫기
        document.addEventListener('click', function(e) {
            if (!settingsPanel.contains(e.target) && e.target !== settingsBtn) {
                settingsPanel.classList.remove('show');
            }
        });

        // 자막 크기 조절
        const sizeSlider = document.getElementById('subtitle-size');
        const sizeValue = document.getElementById('size-value');
        const subtitleText = document.getElementById('subtitle-text');

        sizeSlider.addEventListener('input', function() {
            const size = this.value;
            sizeValue.textContent = size + 'px';
            subtitleText.style.fontSize = size + 'px';
        });

        // 배경 투명도 조절
        const opacitySlider = document.getElementById('subtitle-opacity');
        const opacityValue = document.getElementById('opacity-value');

        opacitySlider.addEventListener('input', function() {
            const opacity = this.value / 100;
            opacityValue.textContent = this.value + '%';
            subtitleText.style.backgroundColor = `rgba(0, 0, 0, ${opacity})`;
        });

        // 배경 색상 변경
        const bgColorPicker = document.getElementById('subtitle-bg-color');
        const colorPreview = document.getElementById('color-preview');

        bgColorPicker.addEventListener('input', function() {
            const color = this.value;
            colorPreview.style.backgroundColor = color;
            const r = parseInt(color.substr(1, 2), 16);
            const g = parseInt(color.substr(3, 2), 16);
            const b = parseInt(color.substr(5, 2), 16);
            const opacity = opacitySlider.value / 100;
            subtitleText.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${opacity})`;
        });

        // 텍스트 색상 변경
        const textColorPicker = document.getElementById('subtitle-text-color');
        const textColorPreview = document.getElementById('text-color-preview');

        textColorPicker.addEventListener('input', function() {
            const color = this.value;
            textColorPreview.style.backgroundColor = color;
            subtitleText.style.color = color;
        });

        // 초기 색상 미리보기 설정
        colorPreview.style.backgroundColor = bgColorPicker.value;
        textColorPreview.style.backgroundColor = textColorPicker.value;

        // 실시간 음성 인식(STT) 및 번역
        const ax2TranslateBtn = document.getElementById('ax2-translate-btn');
        let isTranslating = false;
        let recognition = null;
        let recognitionRunning = false;
        let currentTranscript = '';
        let transcriptHistory = [];

        // Web Speech API 지원 확인
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const isSpeechRecognitionSupported = SpeechRecognition !== undefined;

        // 마이크 상태 업데이트
        function updateMicStatus(active) {
            const micStatus = document.getElementById('mic-status');
            if (active) {
                micStatus.style.display = 'flex';
                micStatus.classList.add('active');
                micStatus.innerHTML = '<span>마이크 활성</span>';
            } else {
                micStatus.style.display = 'none';
                micStatus.classList.remove('active');
            }
        }

        // 음성 인식 초기화
        function initSpeechRecognition() {
            if (!isSpeechRecognitionSupported) {
                console.warn('이 브라우저는 음성 인식을 지원하지 않습니다.');
                return null;
            }

            const recognition = new SpeechRecognition();
            recognition.continuous = true; // 연속 인식
            recognition.interimResults = true; // 중간 결과 표시
            recognition.lang = getSpeechRecognitionLanguage(translationSettings.sourceLanguage);

            recognition.onstart = function() {
                console.log('음성 인식 시작');
                recognitionRunning = true;
                updateMicStatus(true);
            };

            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (finalTranscript) {
                    currentTranscript = finalTranscript.trim();
                    transcriptHistory.push(currentTranscript);
                    
                    // 원본 자막 표시 (원본 언어가 자동 감지가 아닌 경우)
                    if (translationSettings.sourceLanguage !== 'auto') {
                        displaySubtitle(currentTranscript, translationSettings.sourceLanguage);
                    }
                    
                    // 자동 번역
                    if (isTranslating && translationSettings.targetLanguage) {
                        translateAndDisplay(currentTranscript);
                    }
                } else if (interimTranscript) {
                    // 중간 결과 표시
                    displaySubtitle(interimTranscript, translationSettings.sourceLanguage, true);
                }
            };

            recognition.onerror = function(event) {
                console.error('음성 인식 오류:', event.error);
                if (event.error === 'no-speech') {
                    // 음성이 없어도 계속 인식
                    return;
                }
                if (event.error === 'network') {
                    showNotification('네트워크 오류가 발생했습니다.');
                }
            };

            recognition.onend = function() {
                recognitionRunning = false;
                // 번역이 활성화되어 있으면 다시 시작
                if (isTranslating) {
                    updateMicStatus(true); // 재시작 중이므로 활성 상태 유지
                    try {
                        recognition.start();
                    } catch (e) {
                        console.log('음성 인식 재시작 중...');
                        setTimeout(() => {
                            if (isTranslating) {
                                recognition.start();
                            } else {
                                updateMicStatus(false);
                            }
                        }, 100);
                    }
                } else {
                    updateMicStatus(false);
                }
            };

            return recognition;
        }

        // 음성 인식 언어 코드 변환
        function getSpeechRecognitionLanguage(langCode) {
            const langMap = {
                'auto': 'ko-KR', // 기본값
                'ko': 'ko-KR',
                'en': 'en-US',
                'ja': 'ja-JP',
                'zh': 'zh-CN',
                'es': 'es-ES',
                'fr': 'fr-FR'
            };
            return langMap[langCode] || 'ko-KR';
        }

        // 자막 표시
        function displaySubtitle(text, lang, isInterim = false) {
            if (!subtitleToggle.checked) return;
            
            subtitleText.textContent = text;
            if (isInterim) {
                subtitleText.style.opacity = '0.7';
                subtitleText.classList.remove('updating');
            } else {
                subtitleText.style.opacity = '1';
                subtitleText.classList.add('updating');
                setTimeout(() => {
                    subtitleText.classList.remove('updating');
                }, 300);
            }
        }

        // 번역 및 표시
        async function translateAndDisplay(text) {
            try {
                const translatedText = await translateText(
                    text,
                    translationSettings.sourceLanguage,
                    translationSettings.targetLanguage,
                    {
                        contextMode: translationSettings.contextMode,
                        glossaryMode: translationSettings.glossaryMode
                    }
                );
                
                if (subtitleToggle.checked) {
                    subtitleText.textContent = translatedText;
                    subtitleText.style.opacity = '1';
                }
            } catch (error) {
                console.error('번역 오류:', error);
                // 번역 실패 시 원본 텍스트 표시
                displaySubtitle(text, translationSettings.sourceLanguage);
            }
        }

        // 마이크 권한 요청
        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop()); // 권한 확인 후 즉시 종료
                return true;
            } catch (error) {
                console.error('마이크 권한 오류:', error);
                return false;
            }
        }

        // AX2 번역 버튼 클릭
        ax2TranslateBtn.addEventListener('click', async function() {
            if (!isSpeechRecognitionSupported) {
                alert('이 브라우저는 실시간 음성 인식을 지원하지 않습니다.\n\n지원 브라우저:\n- Google Chrome (권장)\n- Microsoft Edge\n- Safari (제한적)\n\n최신 브라우저로 업데이트해주세요.');
                return;
            }

            // 마이크 권한 확인
            const hasPermission = await requestMicrophonePermission();
            if (!hasPermission) {
                alert('마이크 권한이 필요합니다.\n브라우저 설정에서 마이크 권한을 허용해주세요.');
                return;
            }

            isTranslating = !isTranslating;
            
            if (isTranslating) {
                this.textContent = 'AX2 번역 중지';
                this.classList.add('active');
                
                // 번역 설정 적용
                applyTranslationSettings();
                
                // 음성 인식 시작
                if (!recognition) {
                    recognition = initSpeechRecognition();
                }
                
                if (recognition && !recognitionRunning) {
                    try {
                        recognition.lang = getSpeechRecognitionLanguage(translationSettings.sourceLanguage);
                        recognition.start();
                        showNotification('실시간 음성 인식이 시작되었습니다. (' + getLanguageName(translationSettings.targetLanguage) + '로 번역)');
                    } catch (e) {
                        console.error('음성 인식 시작 오류:', e);
                        showNotification('음성 인식을 시작할 수 없습니다. 마이크 권한을 확인해주세요.');
                    }
                }
            } else {
                this.textContent = 'AX2 번역 시작';
                this.classList.remove('active');
                
                // 음성 인식 중지
                if (recognition && recognitionRunning) {
                    recognition.stop();
                    recognitionRunning = false;
                    updateMicStatus(false);
                }
                
                showNotification('음성 인식이 중지되었습니다.');
            }
        });

        // 언어 코드를 언어 이름으로 변환
        function getLanguageName(code) {
            const languages = {
                'ko': '한국어',
                'en': 'English',
                'ja': '日本語',
                'zh': '中文',
                'es': 'Español',
                'fr': 'Français'
            };
            return languages[code] || code;
        }


        // 번역 설정 관련
        const sourceLanguage = document.getElementById('source-language');
        const targetLanguageSettings = document.getElementById('target-language-settings');
        const contextMode = document.getElementById('context-mode');
        const glossaryMode = document.getElementById('glossary-mode');

        // 번역 설정 상태 관리
        let translationSettings = {
            sourceLanguage: sourceLanguage.value,
            targetLanguage: targetLanguageSettings.value,
            contextMode: contextMode.value,
            glossaryMode: glossaryMode.value
        };

        // 설정을 로컬 스토리지에 저장
        function saveTranslationSettings() {
            localStorage.setItem('translationSettings', JSON.stringify(translationSettings));
        }

        // 설정을 로컬 스토리지에서 불러오기
        function loadTranslationSettings() {
            const saved = localStorage.getItem('translationSettings');
            if (saved) {
                translationSettings = JSON.parse(saved);
                sourceLanguage.value = translationSettings.sourceLanguage;
                targetLanguageSettings.value = translationSettings.targetLanguage;
                contextMode.value = translationSettings.contextMode;
                glossaryMode.value = translationSettings.glossaryMode;
            }
        }

        // 원본 언어 변경
        sourceLanguage.addEventListener('change', function() {
            translationSettings.sourceLanguage = this.value;
            saveTranslationSettings();
            console.log('원본 언어 변경:', this.value);
            
            // 음성 인식 언어 업데이트 (실행 중이면)
            if (recognition && recognitionRunning) {
                recognition.stop();
                recognition.lang = getSpeechRecognitionLanguage(translationSettings.sourceLanguage);
                setTimeout(() => {
                    if (isTranslating) {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.log('음성 인식 재시작 중...');
                        }
                    }
                }, 100);
            }
            
            // 번역이 활성화되어 있으면 설정 적용
            if (isTranslating) {
                applyTranslationSettings();
            }
            
            showNotification('원본 언어가 변경되었습니다: ' + this.options[this.selectedIndex].text);
        });

        // 번역 언어 변경
        targetLanguageSettings.addEventListener('change', function() {
            translationSettings.targetLanguage = this.value;
            saveTranslationSettings();
            console.log('번역 언어 변경:', this.value);
            
            // 번역이 활성화되어 있으면 설정 적용
            if (isTranslating) {
                applyTranslationSettings();
                // 최근 인식된 텍스트를 새 언어로 다시 번역
                if (currentTranscript) {
                    translateAndDisplay(currentTranscript);
                }
            }
            
            showNotification('번역 언어가 변경되었습니다: ' + this.options[this.selectedIndex].text);
        });

        // 문맥 유지 모드 변경
        contextMode.addEventListener('change', function() {
            translationSettings.contextMode = this.value;
            saveTranslationSettings();
            console.log('문맥 유지 모드:', this.value);
            
            if (isTranslating) {
                applyTranslationSettings();
            }
            
            showNotification('문맥 유지 모드: ' + (this.value === 'on' ? '켜기' : '끄기'));
        });

        // 전문 용어 사전 모드 변경
        glossaryMode.addEventListener('change', function() {
            translationSettings.glossaryMode = this.value;
            saveTranslationSettings();
            console.log('전문 용어 사전 모드:', this.value);
            
            if (isTranslating) {
                applyTranslationSettings();
            }
            
            showNotification('전문 용어 사전: ' + (this.value === 'on' ? '사용' : '사용 안 함'));
        });

        // 번역 설정 적용 함수
        function applyTranslationSettings() {
            console.log('번역 설정 적용:', translationSettings);
            // 실제 구현 시 여기서 번역 API에 설정값 전달
            // 예: translateAPI.updateSettings(translationSettings);
        }

        // 실제 번역 API 호출 함수
        async function translateText(text, sourceLang, targetLang, options = {}) {
            // 같은 언어면 번역 불필요
            if (sourceLang === targetLang || sourceLang === 'auto' && targetLang === 'ko') {
                return text;
            }

            // 실제 구현 시 API 호출:
            /*
            try {
                const response = await fetch('/api/translate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        sourceLanguage: sourceLang === 'auto' ? 'ko' : sourceLang,
                        targetLanguage: targetLang,
                        contextMode: options.contextMode || translationSettings.contextMode,
                        glossaryMode: options.glossaryMode || translationSettings.glossaryMode,
                        context: options.context || transcriptHistory.slice(-3).join(' ')
                    })
                });
                const data = await response.json();
                return data.translatedText;
            } catch (error) {
                console.error('번역 오류:', error);
                return text;
            }
            */
            
            // 시뮬레이션: 간단한 번역 예시 (실제로는 API 사용)
            const translations = {
                'ko-en': {
                    '안녕하세요': 'Hello',
                    '머신러닝': 'machine learning',
                    '신경망': 'neural network',
                    '강의': 'lecture',
                    '실습': 'practice'
                },
                'en-ko': {
                    'Hello': '안녕하세요',
                    'machine learning': '머신러닝',
                    'neural network': '신경망',
                    'lecture': '강의',
                    'practice': '실습'
                }
            };
            
            // 간단한 시뮬레이션 번역
            const key = `${sourceLang === 'auto' ? 'ko' : sourceLang}-${targetLang}`;
            if (translations[key]) {
                let translated = text;
                for (const [original, translatedWord] of Object.entries(translations[key])) {
                    translated = translated.replace(new RegExp(original, 'gi'), translatedWord);
                }
                return translated || text;
            }
            
            return text;
        }

        // 알림 표시 함수
        function showNotification(message) {
            // 간단한 알림 표시 (실제로는 더 나은 UI로 구현 가능)
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #4a9eff;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                font-size: 14px;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // 초기 설정 로드
        loadTranslationSettings();

        // 강의 종료 및 자동 저장 기능
        const STORAGE_LIMIT = 10; // GB
        const AUTO_DELETE_DAYS = 30; // 30일 후 자동 삭제
        let lectureStartTime = null;
        let lectureDuration = 0;

        // 강의 시작 시간 기록
        function startLecture() {
            lectureStartTime = new Date();
        }

        // 강의 종료 및 자동 저장
        const endLectureBtn = document.getElementById('end-lecture-btn');
        endLectureBtn.addEventListener('click', function() {
            if (!confirm('강의를 종료하고 마이페이지에 저장하시겠습니까?')) return;

            if (lectureStartTime) {
                lectureDuration = Math.floor((new Date() - lectureStartTime) / 1000); // 초 단위
            } else {
                lectureDuration = 0;
            }

            saveLectureToMyPage();
        });

        // 마이페이지에 강의 저장
        function saveLectureToMyPage() {
            // 저장공간 확인
            const savedVideos = JSON.parse(localStorage.getItem('savedVideos') || '[]');
            const usedStorage = parseFloat(localStorage.getItem('usedStorage') || '0');
            
            // 영상 크기 추정 (예: 1시간 = 약 0.5GB)
            const estimatedSize = (lectureDuration / 3600) * 0.5; // GB
            
            if (usedStorage + estimatedSize > STORAGE_LIMIT) {
                alert(`저장공간이 부족합니다. (사용 중: ${usedStorage.toFixed(2)} GB / 제한: ${STORAGE_LIMIT} GB)\n일부 영상을 삭제한 후 다시 시도해주세요.`);
                return;
            }

            // 만료일 계산 (30일 후)
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + AUTO_DELETE_DAYS);

            // 영상 정보 생성
            const videoData = {
                id: 'video_' + Date.now(),
                title: `강의 - ${new Date().toLocaleString('ko-KR')}`,
                savedAt: new Date().toISOString(),
                expiryDate: expiryDate.toISOString(),
                duration: lectureDuration,
                size: estimatedSize,
                sourceLanguage: sourceLanguage.value,
                targetLanguage: targetLanguageSettings.value
            };

            // 저장
            savedVideos.push(videoData);
            const newUsedStorage = usedStorage + estimatedSize;

            localStorage.setItem('savedVideos', JSON.stringify(savedVideos));
            localStorage.setItem('usedStorage', newUsedStorage.toString());

            alert(`강의가 마이페이지에 저장되었습니다.\n크기: ${estimatedSize.toFixed(2)} GB\n만료일: ${expiryDate.toLocaleDateString('ko-KR')}`);
            
            // 마이페이지로 이동
            location.href = 'mypage.html';
        }

        // 페이지 로드 시 강의 시작 시간 기록
        startLecture();
    </script>
</body>
</html>

